<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gestor de Tareas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">

<div class="container">
    <h2 class="mb-4 text-center">Gestor de Tareas</h2>

    <!-- Formulario para nueva tarea -->
    <div class="card p-4 mb-4 shadow">
        <form id="taskForm">
            <input type="hidden" id="userId" th:value="${userId}">

            <div class="mb-3">
                <label class="form-label">Título</label>
                <input type="text" id="title" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Descripción</label>
                <textarea id="description" class="form-control"></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">Estado</label>
                <select id="status" class="form-select">
                    <option value="PENDIENTE">Pendiente</option>
                    <option value="EN_PROGRESO">En Progreso</option>
                    <option value="COMPLETADA">Completada</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">Fecha límite</label>
                <input type="date" id="dueDate" class="form-control">
            </div>

            <button type="submit" class="btn btn-success w-100">Agregar Tarea</button>
        </form>
    </div>

    <!-- Lista de tareas -->
    <ul id="taskList" class="list-group shadow"></ul>
</div>

<script>
    const userId = document.getElementById("userId").value;
    let editingTaskId = null; // null = agregando, distinto de null = editando

    // Cargar tareas
    async function loadTasks() {
        const response = await fetch(`/tasks/all/${userId}`);
        const tasks = await response.json();

        const taskList = document.getElementById("taskList");
        taskList.innerHTML = "";

        tasks.forEach(task => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";

            li.innerHTML = `
                <div>
                    <h6 class="mb-1">${task.title}</h6>
                    <p class="mb-1">${task.description || ""}</p>
                    <small>
                        Estado: <span class="badge bg-${
                            task.status === "COMPLETADA" ? "success" :
                            task.status === "EN_PROGRESO" ? "warning" : "secondary"
                        }">${task.status}</span>
                        | Vence: ${task.dueDate || "Sin fecha"}
                    </small>
                </div>
                <div>
                    <button class="btn btn-sm btn-primary me-2" onclick="editTask(${task.id}, '${task.title}', '${task.description || ""}', '${task.status}', '${task.dueDate || ""}')">Editar</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteTask(${task.id})">Eliminar</button>
                </div>
            `;
            taskList.appendChild(li);
        });
    }

    // Manejar formulario (Agregar o Actualizar)
    document.getElementById("taskForm").addEventListener("submit", async function(e) {
        e.preventDefault();

        const task = {
            title: document.getElementById("title").value,
            description: document.getElementById("description").value,
            status: document.getElementById("status").value,
            dueDate: document.getElementById("dueDate").value,
            user: { id: userId }
        };

        if (editingTaskId) {
            //  Actualizar
            task.id = editingTaskId;
            await fetch(`/tasks/update/${editingTaskId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(task)
            });

            editingTaskId = null; // salir del modo edición
            const button = document.querySelector("#taskForm button");
            button.textContent = "Agregar Tarea";
            button.classList.remove("btn-warning");
            button.classList.add("btn-success");

        } else {
            //  Agregar
            await fetch("/tasks/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(task)
            });
        }

        document.getElementById("taskForm").reset();
        loadTasks();
    });

    //  Editar tarea
    async function editTask(id, title, description, status, dueDate) {
        document.getElementById("title").value = title;
        document.getElementById("description").value = description;
        document.getElementById("status").value = status;
        document.getElementById("dueDate").value = dueDate;

        editingTaskId = id; // marcamos que estamos editando

        const button = document.querySelector("#taskForm button");
        button.textContent = "Actualizar Tarea";
        button.classList.remove("btn-success");
        button.classList.add("btn-warning");
    }

    //  Eliminar tarea
    async function deleteTask(id) {
        await fetch(`/tasks/delete/${id}`, { method: "DELETE" });
        loadTasks();
    }

    // Inicializar
    loadTasks();
</script>

</body>
</html>

